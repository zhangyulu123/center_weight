<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv = "X-UA-Compatible" content = "IE = edge" charset = "UTF-8"/> 
		<title>CenterLoadRate</title>
		<link rel = "stylesheet" href = "../src/main/webapp/pages/css/wanma.css"/>
		<link rel = "stylesheet" href = "../src/main/webapp/tools/easyui/themes/default/easyui.css"/>
		<link rel = "stylesheet" href = "../src/main/webapp/tools/easyui/themes/icon.css"/>
		
		<script type = "text/javascript" src = "../src/main/webapp/tools/tssJS/tssJS.all.js"></script>
		
		<script type = "text/javascript" src = "../src/main/webapp/tools/easyui/jquery.min.js"></script>
		<script type = "text/javascript" src = "../src/main/webapp/tools/easyui/jquery.easyui.min.js"></script>
		<script type = "text/javascript" src = "../src/main/webapp/tools/easyui/easyui-lang-zh_CN.js"></script>
		
		<script type = "text/javascript" src = "../src/main/webapp/tools/echarts/echarts-all-2.1.10.js"></script>
		<script type = "text/javascript" src = "../src/main/webapp/more/bi_template/echart.js"></script>
		<script type = "text/javascript" src = "../src/main/webapp/more/bi_template/common.js"></script>
		<script type = "text/javascript" src = "../src/main/webapp/pages/js/common.js"></script>
		<style type = "text/css">
			#main {
				height:100%;
				width: 100%;
			}
			
			#save1, #save2 {
				z-index: 99;
				position: absolute;
				right: 10px;
			}
			
		</style>
		<script type = "text/javascript">
		
			var	data1, data2,
				method = "POST", 
				DATA_URL1 = "http://10.9.45.68:8080/tss/data/json/2163", //分拨下游
			    DATA_URL2 = "http://10.9.45.68:8080/tss/data/json/2153", //分拨上游
				
			    params = {"param1": "2016-07-30", "param2": "2016-08-02", "param3": "杭州分拨"};
			
			$(function(){
				tssJS.ajax({
					url: DATA_URL1,
					params: params,
					method: method,
					type: "json",
					waiting: true,
					ondata: function(){
						var chtml = varCol(params,1)
						$("#tree1").html(chtml);
						data1 = ShowTree(this.getResponseJSON(),params,1);
						$("#tree1").treegrid({
							idField: "id",
							treeField: "field",
							//width: 900,
							height: 600,
							showFooter: true,
							animate: true,
							data: data1
							
						})
							
					}
				});
				
				tssJS.ajax({
					url: DATA_URL2,
					params: params,
					method: method,
					type: "json",
					waiting: true,
					ondata: function(){
						var chtml = varCol(params,0)
						$("#tree2").html(chtml);
						data2 = ShowTree(this.getResponseJSON(),params,0);
						$("#tree2").treegrid({
							idField: "id",
							treeField: "field",
							//width: 900,
							height: 600,
							showFooter: true,
							animate: true,
							data: data2
							
						})
							
					}
				});
				
				$("#save1").click(function(){
							$(this)[0].download = params.param1.replace(/-/g, "")+params.param2.replace(/-/g, "")+params.param3+"发往各分公司货量装载率统计.csv";
							this.href = "data:text/csv;charset=utf-8,\ufeff" + encodeURIComponent(download_str(data1,params,1));
						});
						
				$("#save2").click(function(){
							$(this)[0].download = params.param1.replace(/-/g, "")+params.param2.replace(/-/g, "")+"各分公司到达"+params.param3+"货量装载率统计.csv";
							this.href = "data:text/csv;charset=utf-8,\ufeff" + encodeURIComponent(download_str(data2,params,0));
						});
			});
			
			//时间列数
			function MonCol(params){
				var start_date = new Date(params.param1.replace(/-/g,"/")).getTime(),
					end_date = new Date(params.param2.replace(/-/g,"/")).getTime(),
					//s = start_date.getTime();
					//e = end_date.getTime(),
					monlist = [];
				while(start_date <= end_date){
					start_date = new Date(start_date);
					var y = start_date.getFullYear(),
						m = start_date.getMonth()+1,
						d = start_date.getDate(); 
					monlist.push(y+"-"+(m>10?m:"0"+m)+"-"+(d>10?d:"0"+d));
					start_date = start_date.getTime() + 24 * 60 * 60 * 1000 //天数加1
				}
				return monlist;
			}
			
			//动态列 p为1时表示从查询分拨发往各分公司，2表示从各分公司到达查询分拨
			function varCol(params,p){
				var cols = MonCol(params);
				str = (p == 0)?("<thead frozen='true'><tr><th field='field' width='200'>各分公司到达"+params.param3+"</th></tr></thead><thead><tr>"):("<thead frozen='true'><tr><th field='field' width='200'>"+params.param3+"发往各分公司</th></tr></thead><thead><tr>")
				for(var i = 0; i < cols.length; i++ ){
					str += "<th colspan = '2'>" + cols[i] + "</th>";
				}
				str += "<th colspan = '2'>均值</th></tr><tr>"
				for(var i = 0; i <= cols.length; i++){
					str += '<th field = "weight'+ i + '" width = "70" align = "right">货量</th><th field = "load'+i+'"width = "70" align = "right">整车运力</th>';
				}
				str += "</tr></thead>"
				return str;
			}
			
			
			function ShowTree(data,params,p){
				var rows = [], footer = [], orglist = [], routelist = [], splitlist = [],
					temp_org = {}, temp_route = {}, temp_split = {}, total = {},
					k = 1;  //k用于标记id
				var monlist = MonCol(params);
				for(var i = 0; i < data.length; i++){
					//第一次初始化
					if(i == 0){
						temp_org["id"] = k;
						temp_route["_parentId"] = k;
						k++;
						temp_route["id"] = k;
						k++;
						temp_org["field"] = (p==1)?(params.param3+"->"+data[i]["org"]):(data[i]["org"]+"->"+params.param3);
						temp_org["state"] = "closed";
						orglist.push(data[i]["org"]);
						temp_route["field"] = data[i]["route_name"];
						//temp_route["state"] = "closed";
						routelist.push(data[i]["org"]+data[i]["route_name"]);
						total["field"] = "合计";
						for(var j = 0; j <= monlist.length; j++){
							eval('temp_org["weight'+ j +'"] = 0');
							eval('temp_org["load'+ j +'"] = 0');
							eval('temp_route["weight'+ j +'"] = 0');
							eval('temp_route["load'+ j +'"] = 0');
							eval('total["weight'+ j +'"] = 0');
							eval('total["load'+ j +'"] = 0');
						};
						
					};
					
					if(!orglist.contains(data[i]["org"])){
						if(orglist.length > 0){
						
							//小数相加后重新定义精确度
							//for(var i = 0; i < monlist.length; i++){
								//eval('temp_org["weight'+i+'"] = Math.round(temp_org["weight'+i+'"]*100)/100');
								//eval('temp_org["load'+i+'"] = Math.round(temp_org["load'+i+'"]*100)/100');
							//}
							
							eval('temp_org["weight'+ monlist.length +'"] = Math.round(temp_org["weight'+monlist.length+'"]/'+monlist.length+'*100)/100');
							eval('temp_org["load'+ monlist.length +'"] = Math.round(temp_org["load'+monlist.length+'"]/'+monlist.length+'*100)/100');
							rows.push(temp_org);
							for(var j = 0; j <= monlist.length; j++){
								eval('total["weight'+ j +'"] += temp_org["weight'+ j +'"]');
								eval('total["load'+ j +'"] += temp_org["load'+ j +'"]');
							}
							temp_org = {};
							orglist.push(data[i]["org"]);
							k++;
							temp_org["id"] = k;
							temp_org["field"] = (p==1)?(params.param3+"->"+data[i]["org"]):(data[i]["org"]+"->"+params.param3);
							temp_org["state"] = "closed";
							for(var j = 0; j <= monlist.length; j++){
								eval('temp_org["weight'+ j +'"] = 0');
								eval('temp_org["load'+ j +'"] = 0');
							}
							
						}
						
						
					};
					
					if(!routelist.contains(data[i]["org"]+data[i]["route_name"])){
						
						if(routelist.length > 0){
						
							
							eval('temp_route["weight'+ monlist.length +'"] = Math.round(temp_route["weight'+monlist.length+'"]/'+monlist.length+'*100)/100');
							eval('temp_route["load'+ monlist.length +'"] = Math.round(temp_route["load'+monlist.length+'"]/'+monlist.length+'*100)/100');
							rows.push(temp_route);
							temp_route = {};
							routelist.push(data[i]["org"]+data[i]["route_name"]);
							temp_route["_parentId"] = temp_org["id"];
							k++;
							temp_route["id"] = k;
							temp_route["field"] = data[i]["route_name"];
							//temp_route["state"] = "closed";
							for(var j = 0; j <= monlist.length; j++){
								eval('temp_route["weight'+ j +'"] = 0');
								eval('temp_route["load'+ j +'"] = 0');
							}
							
						}
						
						
					};
					
					if(!splitlist.contains(data[i]["route_name"]+data[i]["split_route"])){
						if(splitlist.length > 0){
							var cnt = 0; //统计有车线记录的天数，用于求均值
							for(var key in temp_split){
								if(key.indexOf("weight") != -1){
									cnt++;
								}
							};
							eval('temp_split["weight'+ monlist.length +'"] = Math.round(temp_split["weight'+monlist.length+'"]/'+(cnt-1)+'*100)/100');
							eval('temp_split["load'+ monlist.length +'"] = Math.round(temp_split["load'+monlist.length+'"]/'+(cnt-1)+'*100)/100');
							rows.push(temp_split);
							temp_split = {};
							k++;
						}
						splitlist.push(data[i]["route_name"]+data[i]["split_route"]);
						temp_split["_parentId"] = temp_route["id"];
						temp_split["id"] = k;
						temp_split["field"] = data[i]["split_route"];
						//temp_route["state"] = "closed";
						
						eval('temp_split["weight'+ monlist.length +'"] = 0');
						eval('temp_split["load'+ monlist.length +'"] = 0');

						
						
					}
					
					
					
					for(var j = 0; j < monlist.length; j++){
						if(data[i]["inday"] == monlist[j]){
							eval('temp_split["weight'+ j +'"] = '+data[i]["weight"]);
							eval('temp_split["load'+ j +'"] = '+data[i]["load"]);
							eval('temp_route["weight'+ j +'"] += '+data[i]["weight"]);
							eval('temp_route["load'+ j +'"] += '+data[i]["load"]);
							eval('temp_org["weight'+ j +'"] += '+data[i]["weight"]);
							eval('temp_org["load'+ j +'"] += '+data[i]["load"]);
							eval('temp_split["weight'+ monlist.length +'"] += '+data[i]["weight"]);
							eval('temp_split["load'+ monlist.length +'"] += '+data[i]["load"]);
							eval('temp_route["weight'+ monlist.length +'"] += '+data[i]["weight"]);
							eval('temp_route["load'+ monlist.length +'"] += '+data[i]["load"]);
							eval('temp_org["weight'+ monlist.length +'"] += '+data[i]["weight"]);
							eval('temp_org["load'+ monlist.length +'"] += '+data[i]["load"]);
							break;	
						}		
							
					}
					
				};
				
				footer.push(total);
				rows = rows.sort(compare("id"));
				return {"total": rows.length, "rows": rows, "footer": footer};
				
			}
			
			
			//row排序，便于导出
			function compare(propertyName) { 
				return function (object1, object2) { 
						var value1 = object1[propertyName]; 
						var value2 = object2[propertyName]; 
						if (value2 < value1){
							return 1; 
						}else if (value2 > value1){
							return -1;   
						}else {
							return 0; 
						}
					}
			}
			
			function download_str(data, params,p){
				var mon = MonCol(params), 
					rows = data["rows"],
					footer = data["footer"];
				rows.push(footer);
	
				var str = (p==1)? params.param3 +"到达各分公司":params.param3 +"发往各分公司"+",";
				//表头
				for(var j = 0; j < mon.length; j++){
					str += mon[j]+","+""+",";
				}
				str += "均值"+","+""+"\n"+""+",";
				for(var j = 0; j < mon.length; j++){
					str += "货量"+","+"整车运力"+",";
				}
				str += "货量"+","+"整车运力"+"\n";
				for(var i = 0; i < rows.length; i++){
					str += rows[i]["field"] + ","
					for(var j = 0; j <= mon.length; j++){
						if(eval('rows[i]["weight'+j+'"] == undefined')){
							str += ""+","+""+",";
						}else{
							eval('str += rows[i]["weight'+j+'"] + ","+rows[i]["load'+j+'"] + ","');
						}
					}
					str = str.substr(0,str.length-1)+"\n"
				}
				
				return str;
			}
				
		</script>
	<head>
	<body>
		<div id = "main" class = "easyui-tabs">
			<div title = "下游分拨货量装载率统计">
				<a href="#"  id = 'save1' class="easyui-linkbutton" iconCls="icon-save">导出</a>
				<table id = "tree1"></table>
			</div>
			<div title = "上游分拨货量装载率统计">
				<a href="#"  id = 'save2' class="easyui-linkbutton" iconCls="icon-save">导出</a>
				<table id = "tree2"></table>
			</div>
		</div>
	</body>
</html>